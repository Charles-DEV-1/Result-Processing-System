{% extends 'base.html' %}

{% block content %}
<h2>Admin Dashboard - All Results</h2>
<link rel="stylesheet" href="style.css">
<div class="filter-form">
    <form method="GET">
        <div class="form-row">
            <div class="form-group">
                <label>Level</label>
                <select name="level">
                    <option value="">All Levels</option>
                    <option value="100" {% if request.args.get('level') == '100' %}selected{% endif %}>100</option>
                    <option value="200" {% if request.args.get('level') == '200' %}selected{% endif %}>200</option>
                    <option value="300" {% if request.args.get('level') == '300' %}selected{% endif %}>300</option>
                    <option value="400" {% if request.args.get('level') == '400' %}selected{% endif %}>400</option>
                </select>
            </div>
            <div class="form-group">
                <label>Department</label>
                <select name="department">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept[0] }}" {% if request.args.get('department') == dept[0] %}selected{% endif %}>{{ dept[0] }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Semester</label>
                <select name="semester">
                    <option value="">All Semesters</option>
                    <option value="First" {% if request.args.get('semester') == 'First' %}selected{% endif %}>First</option>
                    <option value="Second" {% if request.args.get('semester') == 'Second' %}selected{% endif %}>Second</option>
                </select>
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>
</div>

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('export_excel') }}?level={{ request.args.get('level', '') }}&department={{ request.args.get('department', '') }}&semester={{ request.args.get('semester', '') }}" class="btn btn-success">
        Export to Excel
    </a>
</div>

<div class="table-responsive">
    <table class="table-wrapper">
        <thead>
            <tr>
                <th>Matric No</th>
                <th>Student Name</th>
                {% set all_courses = [] %}
                {% for s in students %}
                    {% for c in s.courses.keys() %}
                        {% if c not in all_courses %}
                            {% set _ = all_courses.append(c) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {% for course in all_courses %}
                    <th>{{ course }}</th>
                {% endfor %}
                <th>GPA</th>
            </tr>
        </thead>

        <tbody>
            {% for s in students %}
            <tr>
                <td data-label="Matric No">{{ s.student.matric_number }}</td>
                <td data-label="Student Name">{{ s.student.full_name }}</td>
                {% for course in all_courses %}
                    <td data-label="{{ course }}">{{ s.courses.get(course, "-") }}</td>
                {% endfor %}
                <td data-label="GPA"><strong>{{ s.gpa }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not students %}
<p style="text-align: center; padding: 40px; color: #999;">No results found. Try adjusting the filters.</p>
{% endif %}
{% endblock %}
